{% extends "layout.html" %}
{% block content %}
<div class="hero mb-4">
  <h3 class="mb-2">Generate Pipeline</h3>
  <p class="kicker">Craft a natural language request. The system builds a dynamic prompt, extracts JSON, validates, and writes ADF JSON to disk.</p>
</div>

<div class="row g-3">
  <div class="col-lg-5">
    <div class="card p-3">
      <h5 class="mb-3">Request</h5>
      <form id="gen-form" class="vstack gap-2">
        <label class="form-label">Requirement</label>
        <textarea class="form-control" name="requirement" rows="4" placeholder='CSV Upload ➜ Databricks PySpark ➜ Snowflake'></textarea>

        <h6 class="mt-2">Context (optional)</h6>
        <div class="row">
          <div class="col">
            <label class="form-label">Source Path</label>
            <input class="form-control" name="source_path" placeholder="mycontainer/sales.csv"/>
          </div>
          <div class="col">
            <label class="form-label">Snowflake Table</label>
            <input class="form-control" name="snowflake_table" placeholder="finance.daily_sales"/>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label class="form-label">Schedule</label>
            <input class="form-control" name="schedule" placeholder="daily"/>
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="submit" class="btn btn-primary">Generate</button>
          <button type="button" id="gen-reset" class="btn btn-outline-light">Reset</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="card p-3">
      <h5 class="mb-3">Result</h5>
      <div id="gen-result" class="mono small muted">Enter a requirement and press Generate.</div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const form = document.getElementById('gen-form');
const result = document.getElementById('gen-result');
const resetBtn = document.getElementById('gen-reset');

function gatherContext(fd){
  const ctx = {};
  for (const [k,v] of fd.entries()){
    if (['source_path','snowflake_table','schedule'].includes(k) && v) ctx[k]=v;
  }
  return ctx;
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  result.innerHTML = 'Generating…';
  const fd = new FormData(form);
  const payload = {
    requirement: fd.get('requirement'),
    context: gatherContext(fd)
  };
  const r = await fetch('/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const json = await r.json();
  if (r.ok) {
    const pretty = JSON.stringify(json, null, 2);
    result.innerHTML = `<pre class="text-wrap">${pretty}</pre>
      <div class="mt-2">Saved to: <span class="mono">${json.saved_to || '(n/a)'}</span></div>`;
  } else {
    result.innerHTML = `<div class="text-danger">Error</div><pre class="text-wrap">${JSON.stringify(json, null, 2)}</pre>`;
  }
});

resetBtn.addEventListener('click', ()=>{
  form.reset();
  result.innerHTML = '<span class="text-secondary">Form cleared.</span>';
});
</script>
{% endblock %}

